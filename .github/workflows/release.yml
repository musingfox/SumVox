name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        env:
          GITHUB_REF: ${{ github.ref }}
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: SumVox ${{ github.ref }}
          draft: true
          prerelease: false

  build-release:
    needs: create-release
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            name: sumvox-macos-aarch64
            use_cross: false
          - target: x86_64-apple-darwin
            os: macos-latest
            name: sumvox-macos-x86_64
            use_cross: false
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: sumvox-linux-x86_64
            use_cross: true
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: sumvox-linux-aarch64
            use_cross: true

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross == true
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build release binary (cross)
        if: matrix.use_cross == true
        env:
          TARGET: ${{ matrix.target }}
        run: cross build --release --target "$TARGET"

      - name: Build release binary (native)
        if: matrix.use_cross == false
        env:
          TARGET: ${{ matrix.target }}
        run: cargo build --release --target "$TARGET"

      - name: Create archive
        env:
          TARGET: ${{ matrix.target }}
          NAME: ${{ matrix.name }}
        run: |
          cd "target/$TARGET/release"
          tar czf "../../../$NAME.tar.gz" sumvox
          cd ../../..

      - name: Calculate SHA256
        id: sha256
        env:
          NAME: ${{ matrix.name }}
        run: |
          SHA256=$(shasum -a 256 "$NAME.tar.gz" | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "$SHA256" > "sha256-$NAME.txt"

      - name: Upload SHA256 as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sha256-${{ matrix.name }}
          path: sha256-${{ matrix.name }}.txt

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./${{ matrix.name }}.tar.gz
          asset_name: ${{ matrix.name }}.tar.gz
          asset_content_type: application/gzip

  update-homebrew:
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Download all SHA256 artifacts
        uses: actions/download-artifact@v4
        with:
          path: sha256-artifacts
          pattern: sha256-*
          merge-multiple: true

      - name: Read SHA256 values
        id: shas
        run: |
          echo "macos_aarch64=$(cat sha256-artifacts/sha256-sumvox-macos-aarch64.txt)" >> $GITHUB_OUTPUT
          echo "macos_x86_64=$(cat sha256-artifacts/sha256-sumvox-macos-x86_64.txt)" >> $GITHUB_OUTPUT
          echo "linux_aarch64=$(cat sha256-artifacts/sha256-sumvox-linux-aarch64.txt)" >> $GITHUB_OUTPUT
          echo "linux_x86_64=$(cat sha256-artifacts/sha256-sumvox-linux-x86_64.txt)" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        env:
          VERSION: ${{ needs.create-release.outputs.version }}
          SHA_MACOS_AARCH64: ${{ steps.shas.outputs.macos_aarch64 }}
          SHA_MACOS_X86_64: ${{ steps.shas.outputs.macos_x86_64 }}
          SHA_LINUX_AARCH64: ${{ steps.shas.outputs.linux_aarch64 }}
          SHA_LINUX_X86_64: ${{ steps.shas.outputs.linux_x86_64 }}
        run: |
          python3 << 'PYEOF'
          import os, re

          version = os.environ["VERSION"]
          shas = {
              "MACOS_AARCH64": os.environ["SHA_MACOS_AARCH64"],
              "MACOS_X86_64": os.environ["SHA_MACOS_X86_64"],
              "LINUX_AARCH64": os.environ["SHA_LINUX_AARCH64"],
              "LINUX_X86_64": os.environ["SHA_LINUX_X86_64"],
          }

          formula_path = "homebrew/sumvox.rb"
          with open(formula_path, "r") as f:
              content = f.read()

          # Update version
          content = re.sub(r'version ".*?"', f'version "{version}"', content)

          # Update all download URLs to new version
          content = re.sub(
              r'(releases/download/v)[^/]+(/.+?\.tar\.gz)',
              rf'\g<1>{version}\2',
              content,
          )

          # Update SHA256 for each platform
          replacements = [
              ("sumvox-macos-aarch64", shas["MACOS_AARCH64"]),
              ("sumvox-macos-x86_64", shas["MACOS_X86_64"]),
              ("sumvox-linux-aarch64", shas["LINUX_AARCH64"]),
              ("sumvox-linux-x86_64", shas["LINUX_X86_64"]),
          ]

          for name, sha in replacements:
              # Match: url line with this name, followed by sha256 line
              pattern = rf'(url ".*?{name}\.tar\.gz"\s*\n\s*sha256 )".*?"'
              replacement = rf'\1"{sha}"'
              content = re.sub(pattern, replacement, content)

          with open(formula_path, "w") as f:
              f.write(content)

          print(f"Updated formula to v{version}")
          for name, sha in replacements:
              print(f"  {name}: {sha}")
          PYEOF

      - name: Publish release (remove draft)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.create-release.outputs.version }}
        run: gh release edit "v$VERSION" --draft=false --repo "$GITHUB_REPOSITORY"

      - name: Commit and push formula update
        env:
          VERSION: ${{ needs.create-release.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add homebrew/sumvox.rb
          git commit -m "chore(homebrew): update formula for v${VERSION}"
          git pull --rebase origin main
          git push origin main

      - name: Update tap repository
        if: ${{ secrets.TAP_REPO_TOKEN != '' }}
        env:
          TAP_REPO_TOKEN: ${{ secrets.TAP_REPO_TOKEN }}
          VERSION: ${{ needs.create-release.outputs.version }}
        run: |
          git clone "https://x-access-token:${TAP_REPO_TOKEN}@github.com/musingfox/homebrew-sumvox.git" tap-repo
          cp homebrew/sumvox.rb tap-repo/Formula/sumvox.rb
          cd tap-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/sumvox.rb
          git commit -m "Update sumvox to v${VERSION}" || echo "No changes to commit"
          git push
